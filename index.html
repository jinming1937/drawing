<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HelloJM!</title>
  <link rel="stylesheet" href="./css/base.css">
  <!-- 初始化 -->
  <script src="./dom/init-canvas.js"></script>
  <!-- 悬浮坐标信息 -->
  <script src="./dom/axis-tips.js"></script>
  <!-- 设置背景 -->
  <script src="./draw/bg.js"></script>
  <!-- 画坐标 -->
  <script src="./draw/axis.js"></script>
  <!-- 画线段 -->
  <script src="./draw/line.js"></script>
  <!-- 鼠标画线 -->
  <script src="./dom/mouse-draw.js"></script>
  <!-- 导出 -->
  <script src="./dom/export-picture.js"></script>
  <!-- request animate frame -->
  <script src="./util/animate.js"></script>
  <!-- 计算矩阵x乘 -->
  <script src="./lib/calculate.js"></script>
  <!-- 计算矩阵坐标 -->
  <script src="./lib/calc-matrix.js"></script>
  <!-- 转化坐标 -->
  <script src="./lib/translate-axis.js"></script>
  <!-- 求斜率 -->
  <script src="./lib/active-path.js"></script>
  <!-- 画文本 -->
  <script src="./draw/text.js"></script>
  <!-- 画框 -->
  <script src="./draw/rect.js"></script>
  <!-- 初始化键盘事件 -->
  <script src="./dom/init-key.js"></script>
</head>
<body>
  <div class="box">
    <canvas id="brick-app">您的浏览器居然不支持canvas元素!!!</canvas>
  </div>
  <div class="tool">
    <input type="button" id="export-picture" class="btn" value="export picture">
    <label>
      line:
      <input type="radio" name="shape" id="line" value="line" checked>
      rect:
      <input type="radio" name="shape" id="rect" value="rect">
    </label>
  </div>
  <script>
    window.onload = function () {
      const {
        // dom
        axisTips,
        initCanvas,
        mouseDraw,
        initKey,
        initExport,
        // draw
        drawAxis,
        setBackground,
        drawText,
        drawLine,
        drawRect,
        // global
        drawData,
        // lib
        activePath,
        calcMatrix,
        calculate3,
        translateAxis,
        // util
        animateFrame,
      } = window;
      console.log('window load ok, start js!!!');

      const width = window.innerWidth;
      const height = window.innerHeight;
      const printerSize = [width, height];
      const [context, canvas] = initCanvas('brick-app', printerSize[0], printerSize[1]);
      axisTips(canvas);
      setBackground(context, '#000000'); // bg
      drawAxis(context);
      initExport(canvas);
      mouseDraw(context); // 绑定

      const startLeft = [-300 , -100];
      const matrixLeft = [15,2,3,4,29,16,7,8,-14];
      const startRight = [60 , -100];
      const matrixRight = [12,8,31,22,12,10,19,29,17];
      const startReturn = [-600, 100];
      const [result, resultStr] = calculate3(matrixLeft, matrixRight);
      const [leftMatrix] = calcMatrix(startLeft, matrixLeft, context);
      const [rightMatrix] = calcMatrix(startRight, matrixRight, context);
      const [resultMatrix] = calcMatrix(startReturn, resultStr, context);
      const startR = [-200, 300];
      const [resultM] = calcMatrix(startR, result, context);
      const allMatrix = [leftMatrix, rightMatrix, resultMatrix, resultM];

      {
        // 画线的前进、后退
        const cache = [];
        initKey(function(action) {
          switch(action) {
            case 'back':
              // command + z, 执行
              if (drawData.length > 0) {
                const shape = drawData.pop();
                if (shape) cache.push(shape);
              }
              break;
            case 'forward':
              if (cache.length > 0) {
                const shape = cache.pop();
                if (shape) drawData.push(shape);
              }
              break;
          }
        });
      }

      // const item = leftMatrix[0];
      // animateFrame(function() {
      //   if (item.x >= -100 || item.y >= 100) {
      //     return;
      //   }
      //   item.x += 2.7;
      //   item.y += 2;
      // });

      animateFrame(function () {
        context.clearRect(0, 0, canvas.width, canvas.height);
        setBackground(context, '#000000');
        drawAxis(context);
        // allMatrix.forEach((arr) => {
        //   arr.forEach((item) => {
        //     drawText(context, '#FFFFFF', item.text, [item.x, item.y]);
        //   });
        // });
        // drawText(context, '#f44336', item.text, [item.x, item.y]);
        drawData.forEach((item) => {
          switch(item.type) {
            case 'line':
              drawLine(context, '#f5f5f5', item.shape);
              break;
            case 'rect':
              drawRect(context, '#f44336', item.shape);
              break;
          }
        })
      });
    }
  </script>
</body>
</html>