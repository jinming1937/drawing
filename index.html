<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HelloJM!</title>
  <link rel="stylesheet" href="./css/base.css">
  <!-- 初始化 -->
  <script src="./dom/init-canvas.js"></script>
  <!-- 悬浮坐标信息 -->
  <script src="./dom/axis-tips.js"></script>
  <!-- 设置背景 -->
  <script src="./draw/bg.js"></script>
  <!-- 画坐标 -->
  <script src="./draw/axis.js"></script>
  <!-- 鼠标画线 -->
  <script src="./dom/mouse-draw.js"></script>
  <!-- 导出 -->
  <script src="./dom/export-picture.js"></script>
  <!-- 导出数据 -->
  <script src="./dom/export-data.js"></script>
  <!-- request animate frame -->
  <script src="./util/animate.js"></script>
  <!-- 画线段 -->
  <script src="./draw/line.js"></script>
  <!-- 画矩形 -->
  <script src="./draw/line-rect.js"></script>
  <!-- 画文本 -->
  <script src="./draw/text.js"></script>
  <!-- 画笔 -->
  <script src="./draw/pen.js"></script>
  <!-- 初始化键盘事件 -->
  <script src="./dom/init-key.js"></script>
</head>
<body>
  <div class="box">
    <canvas id="brick-app">您的浏览器居然不支持canvas元素!!!</canvas>
  </div>
  <div class="tool">
    <input type="button" id="clear-page" class="btn" value="clear" onclick="window.location.reload()">
    <input type="button" id="export-picture" class="btn" value="↓ picture">
    <input type="button" id="export-data" class="btn" value="↓ json">
    <label class="line">
      line:
      <input type="radio" name="shape" id="line" value="line" checked>
      | rect:
      <input type="radio" name="shape" id="rect" value="rect">
      | pen:
      <input type="radio" name="shape" id="pen" value="pen">
      | txt:
      <input type="radio" name="shape" id="txt" value="txt">
    </label>
    <input class="color" type="color" value="#ffffff" name="color" id="color">
    <select class="line-width" name="line-width" id="lineWidth" value="2">
      <option value="1">----- 1px</option>
      <option value="2">==== 2px</option>
      <option value="3">≡≡≡≡ 3px</option>
    </select>
    <label class="label-btn" for="need-axis">
      axis?:
      <input type="checkbox" name="need-axis" id="need-axis" checked>
    </label>
    <select class="line-width" name="theme" id="theme" value="#000000">
      <option value="cadetblue">cadetblue</option>
      <option value="steelblue">steelblue</option>
      <option value="#000000">black</option>
      <option value="#FFFFFF">white</option>
      <option value="oldlace">oldlace</option>
      <option value="gray">gray</option>
      <option value="blue">blue</option>
      <option value="green">green</option>
    </select>
  </div>
  <script>
    window.onload = function () {
      const {
        // dom
        axisTips,
        initCanvas,
        mouseDraw,
        initKey,
        initExportPicture,
        initExportData,
        // draw
        drawAxis,
        setBackground,
        // drawText,
        drawLine,
        // drawRect,
        drawLineRect,
        drawPen,
        // global
        drawData,
        // lib
        // activePath,
        // calcMatrix,
        // calculate3,
        // translateAxis,
        // util
        animateFrame,
      } = window;
      console.log('window load ok, start js!!!');
      const themeDom = document.getElementById('theme');
      const needAxis = document.getElementById('need-axis');
      const [context, canvas] = initCanvas('brick-app', window.innerWidth, window.innerHeight);
      axisTips(canvas); // 坐标提示
      setBackground(context, themeDom.value); // bg
      initExportPicture(canvas); // 绑定导出图片
      initExportData();
      mouseDraw(context); // 绑定事件
      
      {
        // 绘画操作的前进、后退
        const cache = [];
        initKey(function(action) {
          switch(action) {
            case 'back':
              // command + z, 执行
              if (drawData.length > 0) {
                const shape = drawData.pop();
                if (shape) cache.push(shape);
              }
              break;
            case 'forward':
              if (cache.length > 0) {
                const shape = cache.pop();
                if (shape) drawData.push(shape);
              }
              break;
          }
        });
      }

      animateFrame(function () {
        context.clearRect(0, 0, canvas.width, canvas.height);
        setBackground(context, themeDom.value);
        if(needAxis.checked) { drawAxis(context, '#FFFFFF') }
        drawData.forEach((item) => {
          const {type, color, lineWidth, shape} = item;
          switch(type) {
            case 'line':
              drawLine(context, color, lineWidth, shape);
              break;
            case 'rect':
              drawLineRect(context, color, lineWidth, shape);
              break;
            case 'pen':
              drawPen(context, color, lineWidth, shape);
              break;
            case 'txt':
              drawText(context, color, item.text, shape);
              break;
          }
        })
      });
    }
  </script>
</body>
</html>